# NexusHub Database Design Document

## 1. Introduction
This document details the MongoDB database schema for the NexusHub platform. It outlines the collections, fields within those collections, data types, and key relationships.

## 2. Database Technology
- **System:** MongoDB (NoSQL Document Database)
- **Hosting:** Cloud-hosted (e.g., MongoDB Atlas) is recommended for production.

## 3. Naming Conventions
- **Collections:** Plural, lowercase (e.g., `users`, `posts`).
- **Fields:** camelCase (e.g., `authorId`, `createdAt`).
- **Primary Keys:** `_id` (ObjectId, automatically generated by MongoDB).

## 4. Collections and Schemas

### 4.1 `users`
Stores information about registered users.
```json
{
  "_id": "ObjectId",
  "name": "String",
  "email": "String (unique, indexed)",
  "passwordHash": "String",
  "avatarUrl": "String (optional)",
  "bio": "String (optional, max 300 chars)",
  "reputation": "Number (default: 0)",
  "joinedDate": "ISODate",
  "updatedAt": "ISODate",
  "bookmarkedPostIds": ["ObjectId (ref: posts)"],
  "communityIds": ["ObjectId (ref: communities)"],
  "notificationPreferences": {
    "emailNewPosts": "Boolean (default: true)",
    "eventReminders": "Boolean (default: true)",
    "mentionNotifications": "Boolean (default: false)"
  },
  "privacy": "String ('public' | 'private', default: 'public')",
  "resetPasswordToken": "String (optional)",
  "resetPasswordExpires": "ISODate (optional)",
  "subscribedTags": ["String (optional)"],
  "subscribedCategories": ["String (optional)"]
}
```
- **Indexes:** `email: 1 (unique: true)`

### 4.2 `posts`
Stores user-generated posts, including standard content and polls.
```json
{
  "_id": "ObjectId",
  "authorId": "ObjectId (ref: users, indexed)",
  "title": "String (optional, max 150 chars)",
  "content": "String (HTML from Quill for standard, question for poll)",
  "media": [{ // Array of media objects
    "type": "String ('image' | 'video' | 'document')",
    "url": "String (URL to the media file)",
    "name": "String (original file name, optional)"
  }],
  "category": "String (optional, indexed)",
  "tags": ["String (optional, indexed)"],
  "createdAt": "ISODate (indexed)",
  "updatedAt": "ISODate",
  "likedBy": ["ObjectId (ref: users)"],
  "likeCount": "Number (default: 0)",
  "commentIds": ["ObjectId (ref: comments)"],
  "commentCount": "Number (default: 0)",
  "status": "String ('published' | 'draft' | 'scheduled', default: 'published', indexed)",
  "scheduledAt": "ISODate (optional, if status is 'scheduled')",
  "communityId": "ObjectId (optional, ref: communities, indexed)",
  "postType": "String ('standard' | 'poll' | 'question', default: 'standard')",
  "pollOptions": [{ // Only if postType is 'poll'
    "_id": "ObjectId", // Unique ID for each option
    "optionText": "String",
    "votes": "Number (default: 0)",
    "votedBy": ["ObjectId (ref: users)"] // Tracks users who voted for this option
  }],
  "totalVotes": "Number (optional, sum of votes for all options in a poll, default: 0)"
}
```
- **Indexes:** `authorId: 1`, `category: 1`, `tags: 1`, `createdAt: -1`, `status: 1`, `communityId: 1`

### 4.3 `comments`
Stores comments made on posts.
```json
{
  "_id": "ObjectId",
  "postId": "ObjectId (ref: posts, indexed)",
  "authorId": "ObjectId (ref: users, indexed)",
  "parentId": "ObjectId (optional, ref: comments, for threaded replies)",
  "content": "String (max 2000 chars)",
  "createdAt": "ISODate (indexed)",
  "replyIds": ["ObjectId (optional, ref: comments)"] // Could be used for client-side nesting
}
```
- **Indexes:** `postId: 1, createdAt: 1`, `authorId: 1`

### 4.4 `events`
Stores information about community events.
```json
{
  "_id": "ObjectId",
  "title": "String (max 100 chars)",
  "description": "String (max 2000 chars)",
  "imageUrl": "String (optional)",
  "startTime": "ISODate (indexed)",
  "endTime": "ISODate",
  "location": "String (optional)",
  "organizerId": "ObjectId (ref: users, indexed)",
  "rsvpIds": ["ObjectId (ref: users)"],
  "maxAttendees": "Number (optional, positive integer)",
  "category": "String (optional, indexed)",
  "tags": ["String (optional, indexed)"],
  "communityId": "ObjectId (optional, ref: communities, indexed)",
  "price": "Number (optional, non-negative)",
  "currency": "String (optional, e.g., 'USD', max 5 chars)",
  "updatedAt": "ISODate"
}
```
- **Indexes:** `startTime: 1`, `organizerId: 1`, `communityId: 1`, `category: 1`, `tags: 1`

### 4.5 `communities`
Stores information about user-created communities.
```json
{
  "_id": "ObjectId",
  "name": "String (unique, indexed, min 3, max 100 chars)",
  "description": "String (min 10, max 1000 chars)",
  "creatorId": "ObjectId (ref: users)",
  "memberIds": ["ObjectId (ref: users, indexed)"],
  "pendingMemberIds": ["ObjectId (ref: users)"], // For private communities
  "adminIds": ["ObjectId (ref: users, optional)"],
  "coverImageUrl": "String (optional)",
  "privacy": "String ('public' | 'private', indexed)",
  "createdAt": "ISODate (indexed)",
  "updatedAt": "ISODate"
}
```
- **Indexes:** `name: 1 (unique: true)`, `privacy: 1`, `memberIds: 1`

### 4.6 `notifications`
Stores notifications for users.
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId (ref: users, indexed)", // The user who receives the notification
  "type": "String (enum: 'new_comment', 'new_post_subscribed_tag', etc.)",
  "title": "String",
  "message": "String",
  "link": "String (optional, URL to related content)",
  "isRead": "Boolean (default: false, indexed)",
  "createdAt": "ISODate (indexed)",
  "relatedEntityId": "ObjectId (optional, ID of the post, event, comment, etc.)",
  "actor": { // User who performed the action causing the notification
    "_id": "ObjectId (ref: users)",
    "name": "String",
    "avatarUrl": "String (optional)"
  }
}
```
- **Indexes:** `userId: 1, isRead: 1, createdAt: -1`

### 4.7 `reports`
Stores user-submitted reports about content or users.
```json
{
  "_id": "ObjectId",
  "reportedItemId": "ObjectId (indexed, ID of the post, comment, or user being reported)",
  "itemType": "String ('post' | 'comment' | 'user', indexed)",
  "reporterUserId": "ObjectId (ref: users, indexed)",
  "reasonCategory": "String (enum of report reasons)",
  "reasonText": "String (optional, detailed reason)",
  "status": "String ('pending' | 'reviewed_action_taken' | 'reviewed_no_action', default: 'pending', indexed)",
  "createdAt": "ISODate (indexed)",
  "reviewedAt": "ISODate (optional)",
  "reviewerId": "ObjectId (optional, ref: users - admin/moderator who reviewed)",
  "reviewNotes": "String (optional, notes from the reviewer)"
}
```
- **Indexes:** `status: 1, createdAt: 1`, `reporterUserId: 1`, `reportedItemId: 1`

## 5. Relationships
- **User-Post (One-to-Many):** `authorId` in `posts` references `users._id`.
- **Post-Comment (One-to-Many):** `postId` in `comments` references `posts._id`.
- **User-Event (Organizer - One-to-Many):** `organizerId` in `events` references `users._id`.
- **User-Event (RSVP - Many-to-Many):** `rsvpIds` in `events` is an array of `users._id`.
- **User-Community (Creator - One-to-Many):** `creatorId` in `communities` references `users._id`.
- **User-Community (Membership - Many-to-Many):** `memberIds` in `communities` is an array of `users._id`.
- **Post-Community (Optional One-to-Many):** `communityId` in `posts` references `communities._id`.
- **Event-Community (Optional One-to-Many):** `communityId` in `events` references `communities._id`.

## 6. Data Integrity and Consistency
- While MongoDB is schema-less, the application layer (API routes) enforces schema validation using Zod.
- Referential integrity is primarily managed at the application level. For example, when deleting a user, associated content might need to be handled (e.g., anonymized, deleted, or re-assigned if applicable - current implementation might not fully handle all cascading effects).

---
*Document Version: 1.1 (Updated with Polls and Media)*
*Last Updated: (Current Date)*
